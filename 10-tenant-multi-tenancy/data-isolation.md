# Multi-Tenancy Data Isolation Baseline
# 多租户数据隔离基线

## 企业级多租户数据隔离需求基线

---

## 1. 文档元信息（Governance）

**Baseline-ID**: ID-TENANT-ISOLATION  
**Domain**: Multi-Tenancy  
**Baseline-Level**: Enterprise  
**Version**: v1.0.0  
**Status**: Approved  
**Owner**: Security Architecture Committee  
**Effective-Date**: 2024-01-01  
**Review-Cycle**: 12 months

### 1.1 适用范围（Scope）

本 Baseline 适用于：

- SaaS 多租户应用
- 共享数据库架构
- 共享应用架构
- 混合隔离架构

### 1.2 不适用范围（Out of Scope）

- 独立部署的多租户（物理隔离）
- 单租户应用

---

## 2. 设计目标（Security Objectives）

- 确保租户数据完全隔离
- 防止租户间数据泄露
- 支持租户数据合规要求
- 提供租户数据审计能力
- 支持租户数据迁移和删除

---

## 3. 数据隔离模型（Data Isolation Models）

### ISOLATION-01 隔离模型选择

**Level**: MUST

- 系统 **必须** 明确数据隔离模型
- 隔离模型 **必须** 在架构设计阶段确定
- 隔离模型 **必须** 文档化
- 隔离模型变更 **必须** 经过安全评审

**支持的隔离模型**:
- 数据库级隔离（每个租户独立数据库）
- Schema 级隔离（每个租户独立 Schema）
- 行级隔离（共享表，通过租户 ID 隔离）

**验证方法**: 架构审查、隔离模型文档检查

### ISOLATION-02 租户标识

**Level**: MUST

- 系统 **必须** 定义唯一的租户标识（Tenant ID）
- 租户标识 **必须** 不可变
- 租户标识 **必须** 在所有数据表中存在
- 租户标识 **必须** 在 API 请求中传递

**验证方法**: 数据模型审查、API 审查

---

## 4. 数据库隔离（Database Isolation）

### DB-ISOLATION-01 租户 ID 约束

**Level**: MUST

- 所有业务表 **必须** 包含租户 ID 字段
- 租户 ID **必须** 作为主键或唯一索引的一部分
- 查询 **必须** 始终包含租户 ID 过滤
- 租户 ID **禁止** 在应用层过滤（必须在数据库层）

**验证方法**: 数据库 Schema 审查、查询代码审查

### DB-ISOLATION-02 查询隔离

**Level**: MUST

- 所有查询 **必须** 自动添加租户 ID 过滤
- 查询 **禁止** 跨租户查询
- 租户 ID 过滤 **必须** 在 ORM 或数据库视图层实现
- 原始 SQL **必须** 经过安全审查

**验证方法**: 代码审查、查询测试

### DB-ISOLATION-03 数据访问控制

**Level**: MUST

- 数据库用户 **必须** 按租户隔离（如使用 Schema 隔离）
- 数据库连接 **必须** 绑定租户上下文
- 跨租户数据访问 **禁止** 在数据库层
- 数据访问 **必须** 记录审计日志

**验证方法**: 数据库配置审查、访问控制测试

---

## 5. 应用层隔离（Application Layer Isolation）

### APP-ISOLATION-01 租户上下文

**Level**: MUST

- 应用 **必须** 在请求处理开始时识别租户
- 租户标识 **必须** 从认证 Token 或请求头获取
- 租户上下文 **必须** 在请求生命周期中保持
- 租户上下文 **禁止** 从用户输入获取（安全风险）

**验证方法**: 代码审查、租户识别测试

### APP-ISOLATION-02 数据访问层

**Level**: MUST

- 数据访问层 **必须** 自动添加租户 ID 过滤
- 数据访问层 **禁止** 提供跨租户查询接口
- 数据访问层 **必须** 验证租户 ID 有效性
- 数据访问层 **必须** 记录数据访问日志

**验证方法**: 数据访问层代码审查、测试

### APP-ISOLATION-03 缓存隔离

**Level**: MUST

- 缓存 Key **必须** 包含租户 ID
- 缓存 **禁止** 跨租户共享
- 缓存失效 **必须** 按租户隔离
- 缓存 **必须** 支持租户级清理

**验证方法**: 缓存实现审查、缓存隔离测试

---

## 6. API 隔离（API Isolation）

### API-ISOLATION-01 租户验证

**Level**: MUST

- API **必须** 验证租户 ID
- 租户 ID **必须** 与用户所属租户匹配
- 租户验证 **必须** 在授权之前执行
- 租户验证失败 **必须** 返回 403 Forbidden

**验证方法**: API 测试、租户验证审查

### API-ISOLATION-02 资源隔离

**Level**: MUST

- API **必须** 只返回当前租户的资源
- API **禁止** 返回其他租户的资源
- 资源 ID **必须** 验证租户归属
- 跨租户资源访问 **禁止**

**验证方法**: API 测试、资源隔离测试

---

## 7. 文件存储隔离（File Storage Isolation）

### FILE-ISOLATION-01 文件路径隔离

**Level**: MUST

- 文件存储 **必须** 按租户隔离
- 文件路径 **必须** 包含租户 ID
- 文件访问 **必须** 验证租户权限
- 跨租户文件访问 **禁止**

**验证方法**: 文件存储审查、文件访问测试

### FILE-ISOLATION-02 存储配额

**Level**: SHOULD

- **应该** 为每个租户设置存储配额
- 存储配额 **应该** 可配置
- 存储配额超限 **应该** 告警和限制

**验证方法**: 存储配额配置审查

---

## 8. 审计与合规（Audit & Compliance）

### AUDIT-01 租户操作审计

**Level**: MUST

- 所有租户数据操作 **必须** 记录审计日志
- 审计日志 **必须** 包含：租户 ID、用户、操作、时间
- 审计日志 **必须** 不可篡改
- 审计日志 **必须** 支持按租户查询

**验证方法**: 审计日志审查、审计查询测试

### AUDIT-02 数据合规

**Level**: MUST

- 租户数据 **必须** 支持按租户删除（GDPR 合规）
- 租户数据 **必须** 支持按租户导出
- 租户数据删除 **必须** 记录审计日志
- 租户数据 **必须** 支持数据保留策略

**验证方法**: 数据删除测试、合规审查

---

## 9. 测试要求（Testing Requirements）

### TEST-01 隔离测试

**Level**: MUST

- **必须** 测试租户间数据隔离
- **必须** 测试跨租户访问被拒绝
- **必须** 测试租户数据查询正确性
- **必须** 进行渗透测试验证隔离

**验证方法**: 测试用例审查、测试报告

---

## 10. 禁止项（Forbidden）

- 跨租户数据查询
- 无租户 ID 的数据表
- 从用户输入获取租户 ID
- 跨租户资源访问
- 无租户验证的 API

---

## 11. 验收标准（Acceptance Criteria）

### TENANT-AC-01 数据隔离测试

**场景**: 租户 A 尝试访问租户 B 的数据

**预期结果**:
- 访问被拒绝（403）
- 无数据泄露
- 审计日志记录

### TENANT-AC-02 数据查询测试

**场景**: 租户 A 查询自己的数据

**预期结果**:
- 只返回租户 A 的数据
- 不包含其他租户的数据
- 查询性能可接受

---

## 12. 参考标准（References）

- OWASP Multi-Tenancy Security
- GDPR - 数据保护法规
- SOC 2 - 安全控制标准

---

## 13. 变更日志（Changelog）

- v1.0.0 (2024-01-01): 初始版本
