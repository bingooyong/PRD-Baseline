# Circuit Breaker Baseline
# 熔断器基线

## 企业级熔断器与降级需求基线

---

## 1. 文档元信息（Governance）

**Baseline-ID**: ID-AVAIL-CIRCUIT  
**Domain**: Availability & Resilience  
**Baseline-Level**: Enterprise  
**Version**: v1.0.0  
**Status**: Approved  
**Owner**: Platform Architecture Team  
**Effective-Date**: 2024-01-01  
**Review-Cycle**: 12 months

### 1.1 适用范围（Scope）

本 Baseline 适用于：

- 所有外部服务调用（HTTP、RPC、消息队列）
- 数据库连接池
- 缓存连接
- 第三方 API 调用

### 1.2 不适用范围（Out of Scope）

- 内部服务调用（同一进程内）
- 同步文件操作

---

## 2. 设计目标（Objectives）

- 防止级联故障
- 快速失败，避免资源浪费
- 提供降级响应
- 支持自动恢复

---

## 3. 熔断器要求（Circuit Breaker Requirements）

### CIRCUIT-01 熔断器实现

**Level**: MUST

- 所有外部依赖调用 **必须** 实现熔断器
- 熔断器 **必须** 支持三种状态：关闭、开启、半开
- 熔断器状态 **必须** 可监控和告警

**验证方法**: 代码审查、熔断器库使用检查

### CIRCUIT-02 熔断阈值

**Level**: MUST

- 错误率阈值 **必须** 可配置（默认 50%）
- 慢请求阈值 **必须** 可配置（默认 P95 > 1s）
- 请求数量阈值 **必须** 可配置（默认 10 个请求）
- 阈值 **必须** 基于时间窗口（滑动窗口）

**验证方法**: 配置审查、阈值合理性检查

### CIRCUIT-03 熔断持续时间

**Level**: MUST

- 熔断持续时间 **必须** 可配置（默认 60 秒）
- 熔断后 **必须** 进入半开状态测试
- 半开状态测试请求数 **必须** 可配置（默认 3 个）

**验证方法**: 配置审查、熔断测试

### CIRCUIT-04 降级响应

**Level**: MUST

- 熔断触发 **必须** 返回降级响应
- 降级响应 **必须** 明确标识（错误码、错误消息）
- 降级响应 **应该** 返回缓存数据或默认值
- 降级响应 **禁止** 返回空或 null

**验证方法**: 代码审查、降级测试

### CIRCUIT-05 异常分类

**Level**: MUST

- 熔断器 **必须** 区分可重试异常和不可重试异常
- 网络超时、连接失败 **应该** 计入熔断统计
- 业务异常（4xx）**不应该** 计入熔断统计
- 异常分类 **必须** 可配置

**验证方法**: 代码审查、异常处理逻辑检查

### CIRCUIT-06 熔断器监控

**Level**: MUST

- 熔断器状态 **必须** 暴露为指标
- 熔断次数 **必须** 记录和告警
- 熔断持续时间 **必须** 记录
- 熔断器指标 **必须** 集成到监控系统

**验证方法**: 监控系统审查、指标检查

---

## 4. 实现要求（Implementation Requirements）

### CIRCUIT-07 熔断器库

**Level**: MUST

- **必须** 使用成熟的熔断器库（Hystrix、Resilience4j、Sentinel 等）
- **禁止** 自行实现熔断器逻辑
- 熔断器库版本 **必须** 保持更新

**验证方法**: 依赖审查、库版本检查

### CIRCUIT-08 配置管理

**Level**: MUST

- 熔断器配置 **必须** 支持动态调整
- 配置变更 **必须** 不需要重启服务
- 配置 **必须** 有默认值
- 配置 **必须** 有文档说明

**验证方法**: 配置管理审查、文档检查

---

## 5. 禁止项（Forbidden）

- 无熔断器的外部调用
- 熔断后返回空响应
- 不可配置的熔断阈值
- 无监控的熔断器

---

## 6. 验收标准（Acceptance Criteria）

### CIRCUIT-AC-01 熔断触发测试

**场景**: 模拟外部服务故障

**预期结果**:
- 错误率达到阈值后触发熔断
- 熔断后返回降级响应
- 熔断状态可监控

### CIRCUIT-AC-02 熔断恢复测试

**场景**: 外部服务恢复

**预期结果**:
- 熔断持续时间到期后进入半开状态
- 半开状态测试成功后关闭熔断
- 服务恢复正常调用

---

## 7. 参考标准（References）

- Netflix Hystrix - 熔断器模式
- Resilience4j - Java 熔断器库
- Sentinel - 阿里巴巴熔断器框架

---

## 8. 变更日志（Changelog）

- v1.0.0 (2024-01-01): 初始版本
